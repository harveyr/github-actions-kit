name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - uses: actions/checkout@v2

      - uses: actions/setup-node@v1
        with:
          node-version: 10.x

      - run: npm ci

      - run: npm run build

      # Some sanity checks:
      - name: Scripts
        run: npm run print-sha

      - run: npm test

      - run: npx eslint src/**/**.ts

      - run: npx prettier --list-different src/**/**.ts

      - name: Publish
        # FIXME:
        if: github.ref == 'refs/heads/fix-sha'
        run: echo "//npm.pkg.github.com/:_authToken=$TOKEN" > ~/.npmrc
          npm publish --access public --dry-run
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
